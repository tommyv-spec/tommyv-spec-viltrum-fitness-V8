<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <meta name="theme-color" content="#000000">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>Profilo - Viltrum Fitness</title>
  
  <style>
    select, input:not([type="checkbox"]):not([type="radio"]), button { 
      -webkit-appearance: none; -moz-appearance: none; appearance: none;
    }
    html, body { background: #000; }
  </style>
  
  <link rel="manifest" href="../manifest.json">
  <link href="https://fonts.googleapis.com/css2?family=Staatliches&display=swap" rel="stylesheet">
  
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Staatliches', sans-serif; background: #000; color: #fff; min-height: 100vh; }

    .profile-container {
      max-width: 600px; margin: 0 auto;
      padding: calc(env(safe-area-inset-top) + 4rem) 2rem calc(env(safe-area-inset-bottom) + 2rem) 2rem;
    }

    .profile-header { text-align: center; margin-bottom: 2rem; padding-bottom: 2rem; border-bottom: 1px solid rgba(255,255,255,0.1); }
    .profile-avatar {
      width: 100px; height: 100px; border-radius: 50%;
      background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
      display: flex; align-items: center; justify-content: center;
      font-size: 3rem; margin: 0 auto 1rem;
    }
    .profile-name { font-size: 2rem; color: #fff; margin-bottom: 0.5rem; }
    .profile-email { color: #999; font-size: 1rem; }

    .subscription-card {
      background: linear-gradient(135deg, rgba(76,175,80,0.1) 0%, rgba(69,160,73,0.1) 100%);
      border-radius: 15px; padding: 1.5rem; margin-bottom: 2rem;
      border: 1px solid rgba(76,175,80,0.3);
    }
    .subscription-card.expired { background: linear-gradient(135deg, rgba(244,67,54,0.1) 0%, rgba(211,47,47,0.1) 100%); border-color: rgba(244,67,54,0.3); }
    .subscription-card.trial { background: linear-gradient(135deg, rgba(33,150,243,0.1) 0%, rgba(25,118,210,0.1) 100%); border-color: rgba(33,150,243,0.3); }
    .subscription-status { font-size: 1.5rem; font-weight: bold; margin-bottom: 0.5rem; color: #4CAF50; }
    .subscription-card.expired .subscription-status { color: #f44336; }
    .subscription-card.trial .subscription-status { color: #2196F3; }
    .subscription-details { color: #ccc; font-size: 0.875rem; }

    .profile-section { background: rgba(255,255,255,0.05); border-radius: 15px; padding: 1.5rem; margin-bottom: 1.5rem; }
    .profile-section h2 { font-size: 1.5rem; color: #fff; margin-bottom: 1rem; text-transform: uppercase; }

    .form-group { margin-bottom: 1.5rem; }
    .form-group label { display: block; color: #999; font-size: 0.875rem; margin-bottom: 0.5rem; }
    .form-group input {
      width: 100%; padding: 0.75rem; background: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: #fff; font-size: 1rem;
    }
    .form-group input:focus { outline: none; border-color: #4CAF50; }

    .button-group { display: flex; gap: 1rem; margin-top: 1rem; }
    .btn {
      flex: 1; padding: 0.75rem 1.5rem; border-radius: 8px; font-weight: bold;
      cursor: pointer; transition: all 0.3s ease; border: none;
      font-family: 'Staatliches', sans-serif; text-transform: uppercase; letter-spacing: 1px;
    }
    .btn-primary { background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); color: #fff; }
    .btn-secondary { background: rgba(255,255,255,0.1); color: #fff; border: 1px solid rgba(255,255,255,0.2); }
    .btn-danger { background: rgba(244,67,54,0.2); color: #f44336; border: 1px solid rgba(244,67,54,0.5); }
    .btn:active { transform: scale(0.98); }

    .back-button {
      position: fixed; top: calc(env(safe-area-inset-top) + 1rem); left: 1rem;
      background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2);
      color: #fff; padding: 0.5rem 1rem; border-radius: 8px; text-decoration: none;
      font-weight: bold; backdrop-filter: blur(10px); z-index: 100;
    }

    .success-message, .error-message { padding: 1rem; border-radius: 8px; margin-bottom: 1rem; display: none; }
    .success-message { background: rgba(76,175,80,0.2); border: 1px solid rgba(76,175,80,0.5); color: #4CAF50; }
    .error-message { background: rgba(244,67,54,0.2); border: 1px solid rgba(244,67,54,0.5); color: #f44336; }
    .success-message.show, .error-message.show { display: block; }
  </style>
</head>
<body>
  <a href="../pages/dashboard-v7.html" class="back-button">‚Üê Dashboard</a>

  <div class="profile-container">
    <div class="profile-header">
      <div class="profile-avatar">üë§</div>
      <h1 class="profile-name" id="profile-name">Caricamento...</h1>
      <p class="profile-email" id="profile-email">email@example.com</p>
    </div>

    <div class="subscription-card" id="subscription-card">
      <div class="subscription-status" id="subscription-status">Caricamento...</div>
      <div class="subscription-details" id="subscription-details">Caricamento informazioni...</div>
    </div>

    <div class="profile-section">
      <h2>Modifica Username</h2>
      <div class="success-message" id="username-success"></div>
      <div class="error-message" id="username-error"></div>
      <form id="username-form">
        <div class="form-group">
          <label for="new-username">Nuovo Username</label>
          <input type="text" id="new-username" placeholder="Es. GymMaster2025" required>
        </div>
        <div class="button-group">
          <button type="submit" class="btn btn-primary">Aggiorna Username</button>
        </div>
      </form>
    </div>

    <div class="profile-section">
      <h2>Modifica Email</h2>
      <div class="success-message" id="email-success"></div>
      <div class="error-message" id="email-error"></div>
      <form id="email-form">
        <div class="form-group">
          <label for="new-email">Nuova Email</label>
          <input type="email" id="new-email" placeholder="nuova@email.com" required>
        </div>
        <div class="form-group">
          <label for="email-current-password">Password Attuale (per conferma)</label>
          <input type="password" id="email-current-password" placeholder="Password" required>
        </div>
        <div class="button-group">
          <button type="submit" class="btn btn-primary">Aggiorna Email</button>
        </div>
      </form>
    </div>

    <div class="profile-section">
      <h2>Modifica Password</h2>
      <div class="success-message" id="password-success"></div>
      <div class="error-message" id="password-error"></div>
      <form id="password-form">
        <div class="form-group">
          <label for="new-password">Nuova Password</label>
          <input type="password" id="new-password" placeholder="Minimo 6 caratteri" required minlength="6">
        </div>
        <div class="form-group">
          <label for="confirm-password">Conferma Password</label>
          <input type="password" id="confirm-password" placeholder="Ripeti password" required minlength="6">
        </div>
        <div class="button-group">
          <button type="submit" class="btn btn-primary">Aggiorna Password</button>
        </div>
      </form>
    </div>

    <div class="profile-section">
      <h2>Azioni Account</h2>
      <div class="button-group">
        <button class="btn btn-secondary" onclick="window.location.href='../pages/dashboard-v7.html'">Torna alla Dashboard</button>
        <button class="btn btn-danger" onclick="confirmLogout()">Esci</button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script type="module">
    import { getUserProfile, updateUsername, updateEmail, getSubscriptionMessage, formatExpiryDate } from '../js/profile-manager.js';
    import { SUPABASE_URL, SUPABASE_ANON_KEY } from '../js/config.js';

    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Load profile data
    async function loadProfile() {
      const profile = await getUserProfile();
      if (!profile) { window.location.href = '../index.html'; return; }

      document.getElementById('profile-name').textContent = profile.username || 'User';
      document.getElementById('profile-email').textContent = profile.email || 'email@example.com';
      document.getElementById('new-username').value = profile.username || '';

      const subCard = document.getElementById('subscription-card');
      const subStatus = document.getElementById('subscription-status');
      const subDetails = document.getElementById('subscription-details');

      if (profile.subscription) {
        const message = getSubscriptionMessage(profile.subscription);
        subStatus.textContent = message;
        subDetails.textContent = profile.subscription.expiryDate 
          ? `Scadenza: ${formatExpiryDate(profile.subscription.expiryDate)}`
          : 'Nessuna data di scadenza';

        subCard.classList.remove('expired', 'trial');
        if (profile.subscription.status === 'expired') subCard.classList.add('expired');
        else if (profile.subscription.status === 'trial') subCard.classList.add('trial');
      }
    }

    // Username update
    document.getElementById('username-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const newUsername = document.getElementById('new-username').value;
      const successMsg = document.getElementById('username-success');
      const errorMsg = document.getElementById('username-error');
      
      successMsg.classList.remove('show');
      errorMsg.classList.remove('show');

      const result = await updateUsername(newUsername);
      
      if (result.success) {
        successMsg.textContent = '‚úÖ Username aggiornato con successo!';
        successMsg.classList.add('show');
        document.getElementById('profile-name').textContent = newUsername;
      } else {
        errorMsg.textContent = '‚ùå ' + (result.error || 'Errore durante l\'aggiornamento');
        errorMsg.classList.add('show');
      }
    });

    // Email update
    document.getElementById('email-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const newEmail = document.getElementById('new-email').value;
      const password = document.getElementById('email-current-password').value;
      const successMsg = document.getElementById('email-success');
      const errorMsg = document.getElementById('email-error');
      
      successMsg.classList.remove('show');
      errorMsg.classList.remove('show');

      const result = await updateEmail(newEmail, password);
      
      if (result.success) {
        successMsg.textContent = '‚úÖ ' + (result.message || 'Email aggiornata!');
        successMsg.classList.add('show');
        document.getElementById('profile-email').textContent = newEmail;
        document.getElementById('email-current-password').value = '';
      } else {
        errorMsg.textContent = '‚ùå ' + (result.error || 'Errore durante l\'aggiornamento');
        errorMsg.classList.add('show');
      }
    });

    // Password update
    document.getElementById('password-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const newPassword = document.getElementById('new-password').value;
      const confirmPassword = document.getElementById('confirm-password').value;
      const successMsg = document.getElementById('password-success');
      const errorMsg = document.getElementById('password-error');
      
      successMsg.classList.remove('show');
      errorMsg.classList.remove('show');

      if (newPassword !== confirmPassword) {
        errorMsg.textContent = '‚ùå Le password non corrispondono';
        errorMsg.classList.add('show');
        return;
      }

      if (newPassword.length < 6) {
        errorMsg.textContent = '‚ùå Password deve essere di almeno 6 caratteri';
        errorMsg.classList.add('show');
        return;
      }

      try {
        const { error } = await supabase.auth.updateUser({ password: newPassword });
        
        if (error) {
          errorMsg.textContent = '‚ùå ' + error.message;
          errorMsg.classList.add('show');
        } else {
          successMsg.textContent = '‚úÖ Password aggiornata con successo!';
          successMsg.classList.add('show');
          document.getElementById('new-password').value = '';
          document.getElementById('confirm-password').value = '';
        }
      } catch (error) {
        errorMsg.textContent = '‚ùå Errore durante l\'aggiornamento';
        errorMsg.classList.add('show');
      }
    });

    // Logout
    window.confirmLogout = async function() {
      if (confirm('Sei sicuro di voler uscire?')) {
        try {
          await supabase.auth.signOut();
          console.log('[Logout] Signed out from Supabase');
        } catch (error) {
          console.error('[Logout] Error signing out from Supabase:', error);
        }
        
        // Clear all localStorage
        localStorage.removeItem('loggedUser');
        localStorage.removeItem('userName');
        localStorage.removeItem('userFullName');
        localStorage.removeItem('viltrum_user_settings');
        localStorage.removeItem('viltrum_last_workout_index');
        localStorage.removeItem('viltrum_exercise_weights');
        localStorage.removeItem('viltrum_total_workouts');
        localStorage.removeItem('viltrum_user_cache');
        
        // Clear sessionStorage
        sessionStorage.clear();
        
        window.location.href = '../index.html';
      }
    };

    // Initialize
    loadProfile();
  </script>
</body>
</html>