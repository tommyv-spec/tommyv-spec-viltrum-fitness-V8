<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <title>Endurance - Viltrum Fitness</title>
  
  <link href="https://fonts.googleapis.com/css2?family=Staatliches&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="../css/main.css" />
  <link rel="manifest" href="../manifest.json" />
  <meta name="theme-color" content="#000000" />
  <link rel="apple-touch-icon" href="../icons/icon-192x192.png" />
  
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body {
      height: 100vh; height: 100dvh;
      width: 100%; font-family: 'Staatliches', sans-serif;
      background: #000; color: #FFF; overflow: hidden;
      -webkit-user-select: none; user-select: none;
    }
    
    .container {
      height: 100vh; height: 100dvh;
      display: flex; flex-direction: column;
      padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
    }

    /* Header */
    header {
      flex-shrink: 0; height: 7vh; min-height: 50px;
      display: flex; align-items: center; justify-content: space-between;
      padding: 0 4vw; background: rgba(20,20,20,0.95);
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    .header-title { font-size: 2.2vh; letter-spacing: 2px; }
    .header-btn {
      padding: 1vh 2vw; background: transparent; border: 1px solid rgba(255,255,255,0.3);
      border-radius: 8px; color: #FFF; font-family: inherit; font-size: 1.6vh;
      cursor: pointer; transition: all 0.2s;
    }
    .header-btn:active { background: rgba(255,255,255,0.1); }

    /* Zone Colors */
    .zone-1 { --zone-color: #3498db; --zone-bg: rgba(52,152,219,0.15); }
    .zone-2 { --zone-color: #27ae60; --zone-bg: rgba(39,174,96,0.15); }
    .zone-3 { --zone-color: #f1c40f; --zone-bg: rgba(241,196,15,0.15); }
    .zone-4 { --zone-color: #e67e22; --zone-bg: rgba(230,126,34,0.15); }
    .zone-5 { --zone-color: #e74c3c; --zone-bg: rgba(231,76,60,0.15); }

    /* Views */
    .view { display: none; flex: 1; flex-direction: column; overflow: hidden; }
    .view.active { display: flex; }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    /* SELECTOR VIEW */
    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .selector-view { padding: 2vh 4vw; }
    .selector-title { text-align: center; margin-bottom: 2vh; }
    .selector-title h2 { font-size: 2.8vh; letter-spacing: 1.5px; }
    .selector-title p { color: #888; font-size: 1.5vh; }

    .workout-list { flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 1.5vh; -webkit-overflow-scrolling: touch; }
    .workout-card {
      background: linear-gradient(135deg, rgba(60,60,60,0.5), rgba(40,40,40,0.3));
      border: 2px solid #444; border-radius: 15px; padding: 2vh 3vw;
      display: flex; align-items: center; gap: 3vw;
      cursor: pointer; transition: all 0.2s;
    }
    .workout-card:active { transform: scale(0.98); border-color: #FFF; }
    .workout-icon {
      width: 7vh; height: 7vh; background: rgba(255,255,255,0.08);
      border: 2px solid rgba(255,255,255,0.15); border-radius: 12px;
      display: flex; align-items: center; justify-content: center; flex-shrink: 0;
    }
    .workout-icon svg { width: 4vh; height: 4vh; stroke: #FFF; fill: none; stroke-width: 1.5; }
    .workout-info { flex: 1; }
    .workout-info h3 { font-size: 2vh; letter-spacing: 0.5px; margin-bottom: 0.3vh; }
    .workout-info p { color: #888; font-size: 1.4vh; }
    .workout-arrow { color: #666; font-size: 2.5vh; }

    .no-workouts { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; color: #666; }
    .no-workouts svg { width: 10vh; height: 10vh; margin-bottom: 2vh; stroke: #444; }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    /* WORKOUT VIEW */
    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    
    /* Top Progress Bar */
    .workout-progress-bar {
      flex-shrink: 0; height: 4px; background: rgba(255,255,255,0.1);
    }
    .workout-progress-bar .fill {
      height: 100%; background: #4CAF50; transition: width 0.3s ease;
    }

    /* Workout Header */
    .workout-header {
      flex-shrink: 0; padding: 1.5vh 4vw;
      background: rgba(25,25,25,0.98); border-bottom: 1px solid rgba(255,255,255,0.08);
      display: flex; align-items: center; justify-content: space-between;
    }
    .workout-name { font-size: 1.8vh; letter-spacing: 1px; opacity: 0.9; }
    .phase-counter { font-size: 1.5vh; color: #888; }

    /* GPS Stats Bar */
    .gps-bar {
      flex-shrink: 0; padding: 1.2vh 4vw;
      background: rgba(30,30,30,0.95); border-bottom: 1px solid rgba(255,255,255,0.05);
      display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 2vw;
    }
    .gps-stat { text-align: center; }
    .gps-stat-value { font-size: 2.8vh; font-weight: bold; line-height: 1.2; }
    .gps-stat-value.highlight { color: #4CAF50; }
    .gps-stat-label { font-size: 1.1vh; color: #666; text-transform: uppercase; letter-spacing: 1px; }

    /* Phase Display - Main Area */
    .phase-display {
      flex: 1; display: flex; flex-direction: column;
      padding: 3vh 4vw; overflow: hidden;
    }

    /* Section Label */
    .section-label {
      text-align: center; font-size: 1.4vh; letter-spacing: 2px;
      text-transform: uppercase; color: #888; margin-bottom: 1vh;
    }

    /* Phase Card */
    .phase-card {
      flex: 1; display: flex; flex-direction: column;
      align-items: center; justify-content: center;
      background: var(--zone-bg, rgba(50,50,50,0.3));
      border: 3px solid var(--zone-color, #555);
      border-radius: 20px; padding: 3vh 4vw;
      position: relative; overflow: hidden;
    }

    .zone-badge {
      position: absolute; top: 2vh; right: 3vw;
      padding: 0.8vh 2vw; background: var(--zone-color);
      border-radius: 20px; font-size: 1.4vh; font-weight: bold;
      color: #000; letter-spacing: 1px;
    }

    .phase-value {
      font-size: 12vh; font-weight: bold; line-height: 1;
      color: var(--zone-color, #FFF);
    }
    .phase-unit { font-size: 3vh; color: #888; margin-top: 0.5vh; }
    .phase-description { font-size: 2vh; color: #CCC; margin-top: 1.5vh; text-align: center; }

    /* Loop Indicator */
    .loop-indicator {
      position: absolute; bottom: 2vh; left: 50%; transform: translateX(-50%);
      display: flex; align-items: center; gap: 1vw;
      padding: 0.8vh 3vw; background: rgba(0,0,0,0.4);
      border-radius: 20px; font-size: 1.4vh; color: #888;
    }
    .loop-dots { display: flex; gap: 0.8vw; }
    .loop-dot {
      width: 10px; height: 10px; border-radius: 50%;
      background: rgba(255,255,255,0.2); transition: all 0.3s;
    }
    .loop-dot.active { background: var(--zone-color, #4CAF50); }
    .loop-dot.completed { background: rgba(76,175,80,0.6); }

    /* Phase Progress Bar */
    .phase-progress {
      width: 100%; margin-top: 2vh;
    }
    .phase-progress-track {
      width: 100%; height: 12px; background: rgba(255,255,255,0.1);
      border-radius: 6px; overflow: hidden;
    }
    .phase-progress-fill {
      height: 100%; background: var(--zone-color, #4CAF50);
      border-radius: 6px; transition: width 0.3s ease;
      box-shadow: 0 0 10px var(--zone-color, #4CAF50);
    }
    .phase-progress-text {
      display: flex; justify-content: space-between;
      margin-top: 0.8vh; font-size: 1.4vh; color: #888;
    }

    /* Next Phase Preview */
    .next-preview {
      flex-shrink: 0; padding: 1.5vh 4vw;
      background: rgba(20,20,20,0.95); border-top: 1px solid rgba(255,255,255,0.05);
    }
    .next-preview-label { font-size: 1.2vh; color: #555; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 0.5vh; }
    .next-preview-content { font-size: 1.6vh; color: #888; }

    /* Controls */
    .controls {
      flex-shrink: 0; padding: 2vh 4vw 3vh;
      background: rgba(15,15,15,0.98); border-top: 1px solid rgba(255,255,255,0.08);
      display: flex; gap: 3vw;
    }
    .ctrl-btn {
      flex: 1; padding: 2.2vh; border-radius: 12px;
      font-family: inherit; font-size: 1.8vh; letter-spacing: 1px;
      cursor: pointer; transition: all 0.2s; border: none;
      display: flex; align-items: center; justify-content: center; gap: 1.5vw;
    }
    .ctrl-btn.primary { background: #FFF; color: #000; }
    .ctrl-btn.primary:active { background: #DDD; }
    .ctrl-btn.secondary { background: transparent; color: #FFF; border: 2px solid #555; }
    .ctrl-btn.secondary:active { background: rgba(255,255,255,0.05); }
    .ctrl-btn.complete { background: #4CAF50; color: #FFF; }
    .ctrl-btn.pause { background: #FF9800; color: #000; }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    /* COMPLETION VIEW */
    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .completion-view {
      align-items: center; justify-content: center; padding: 4vh; text-align: center;
    }
    .completion-icon {
      width: 15vh; height: 15vh; background: rgba(76,175,80,0.15);
      border: 3px solid #4CAF50; border-radius: 50%;
      display: flex; align-items: center; justify-content: center; margin-bottom: 3vh;
    }
    .completion-icon svg { width: 8vh; height: 8vh; stroke: #4CAF50; fill: none; stroke-width: 2; }
    .completion-view h2 { font-size: 3.5vh; letter-spacing: 2px; margin-bottom: 1vh; }
    .completion-view p { color: #888; font-size: 1.8vh; margin-bottom: 3vh; }
    .completion-stats {
      display: grid; grid-template-columns: 1fr 1fr; gap: 3vw;
      padding: 2vh 4vw; background: rgba(255,255,255,0.03);
      border-radius: 12px; margin-bottom: 3vh; width: 80%; max-width: 300px;
    }
    .completion-stat { text-align: center; }
    .completion-stat-value { font-size: 3vh; color: #4CAF50; }
    .completion-stat-label { font-size: 1.3vh; color: #666; text-transform: uppercase; }
    .completion-btn {
      padding: 2vh 8vw; background: #FFF; color: #000;
      border: none; border-radius: 12px; font-family: inherit;
      font-size: 2vh; letter-spacing: 1px; cursor: pointer;
    }

    /* Loading */
    .loading { flex: 1; display: flex; align-items: center; justify-content: center; }
    .spinner { width: 5vh; height: 5vh; border: 3px solid rgba(255,255,255,0.1); border-top-color: #FFF; border-radius: 50%; animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* GPS Status Indicator */
    .gps-status {
      position: absolute; top: 2vh; left: 3vw;
      display: flex; align-items: center; gap: 1vw;
      font-size: 1.2vh; color: #666;
    }
    .gps-dot {
      width: 8px; height: 8px; border-radius: 50%;
      background: #666; transition: all 0.3s;
    }
    .gps-dot.searching { background: #f1c40f; animation: pulse 1s infinite; }
    .gps-dot.active { background: #4CAF50; }
    .gps-dot.error { background: #e74c3c; }
    @keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: 0.4; } }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <button class="header-btn" onclick="goBack()">â† INDIETRO</button>
      <h1 class="header-title">ENDURANCE</h1>
      <div style="width: 80px;"></div>
    </header>

    <!-- Loading View -->
    <div id="loading-view" class="view active">
      <div class="loading"><div class="spinner"></div></div>
    </div>

    <!-- Selector View -->
    <div id="selector-view" class="view selector-view">
      <div class="selector-title">
        <h2>ğŸƒ RUNNING WORKOUTS</h2>
        <p>Seleziona il tuo allenamento</p>
      </div>
      <div id="workout-list" class="workout-list"></div>
      <div id="no-workouts" class="no-workouts" style="display: none;">
        <svg viewBox="0 0 24 24" stroke-width="1.5"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>
        <h3>NESSUN WORKOUT</h3>
        <p>I workout di running saranno disponibili presto.</p>
      </div>
    </div>

    <!-- Workout View -->
    <div id="workout-view" class="view">
      <div class="workout-progress-bar"><div id="total-progress-fill" class="fill" style="width: 0%;"></div></div>
      
      <div class="workout-header">
        <span id="workout-name" class="workout-name">-</span>
        <span id="phase-counter" class="phase-counter">1 / 1</span>
      </div>

      <div class="gps-bar">
        <div class="gps-stat">
          <div id="gps-distance" class="gps-stat-value highlight">0.00</div>
          <div class="gps-stat-label">KM Totali</div>
        </div>
        <div class="gps-stat">
          <div id="gps-time" class="gps-stat-value">00:00</div>
          <div class="gps-stat-label">Tempo</div>
        </div>
        <div class="gps-stat">
          <div id="gps-pace" class="gps-stat-value">--:--</div>
          <div class="gps-stat-label">Passo</div>
        </div>
      </div>

      <div class="phase-display">
        <div id="section-label" class="section-label">WARMUP</div>
        
        <div id="phase-card" class="phase-card zone-2">
          <div class="gps-status">
            <div id="gps-dot" class="gps-dot"></div>
            <span id="gps-status-text">GPS OFF</span>
          </div>
          
          <div id="zone-badge" class="zone-badge">ZONA 2</div>
          
          <div id="phase-value" class="phase-value">4</div>
          <div id="phase-unit" class="phase-unit">chilometri</div>
          <div id="phase-description" class="phase-description">Corsa lenta</div>
          
          <div id="loop-indicator" class="loop-indicator" style="display: none;">
            <span id="loop-text">Ripetizione 1/3</span>
            <div id="loop-dots" class="loop-dots"></div>
          </div>
          
          <div class="phase-progress">
            <div class="phase-progress-track">
              <div id="phase-progress-fill" class="phase-progress-fill" style="width: 0%;"></div>
            </div>
            <div class="phase-progress-text">
              <span id="phase-current">0</span>
              <span id="phase-target">4 km</span>
            </div>
          </div>
        </div>
      </div>

      <div class="next-preview">
        <div class="next-preview-label">Prossimo</div>
        <div id="next-preview-content" class="next-preview-content">3x (100m Z4 + 100m Z1)</div>
      </div>

      <div class="controls">
        <button class="ctrl-btn secondary" onclick="prevPhase()">â† PREV</button>
        <button id="pause-btn" class="ctrl-btn pause" onclick="togglePause()">â¸ï¸ PAUSA</button>
        <button id="next-btn" class="ctrl-btn primary" onclick="nextPhase()">NEXT â†’</button>
      </div>
    </div>

    <!-- Completion View -->
    <div id="completion-view" class="view completion-view">
      <div class="completion-icon">
        <svg viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg>
      </div>
      <h2>OTTIMO LAVORO! ğŸ‰</h2>
      <p>Hai completato il workout</p>
      <div id="completion-stats" class="completion-stats">
        <div class="completion-stat">
          <div id="final-distance" class="completion-stat-value">0.00 km</div>
          <div class="completion-stat-label">Distanza</div>
        </div>
        <div class="completion-stat">
          <div id="final-time" class="completion-stat-value">00:00</div>
          <div class="completion-stat-label">Tempo</div>
        </div>
      </div>
      <button class="completion-btn" onclick="goBackToDashboard()">TORNA ALLA DASHBOARD</button>
    </div>
  </div>

  <script src="../viewport.js"></script>
  <script type="module">
    import DataPreloader from '../js/data-preloader.js';
    import { GOOGLE_SCRIPT_URL } from '../js/config.js';

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // STATE
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    let runWorkouts = {};
    let currentWorkout = null;
    let currentWorkoutName = '';
    let expandedPhases = [];      // Flattened phases with loops expanded
    let currentPhaseIndex = 0;
    let isPaused = false;
    let v7PlanInfo = null;

    // GPS State
    let gpsWatchId = null;
    let gpsPositions = [];
    let totalDistance = 0;        // meters
    let phaseDistance = 0;        // meters for current phase
    let startTime = null;
    let phaseStartTime = null;
    let timerInterval = null;
    let countdownInterval = null;
    let phaseTimeRemaining = 0;   // seconds for time-based phases
    let wakeLock = null;

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // INITIALIZATION
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    async function init() {
      console.log('ğŸƒ Endurance V2 Initializing...');
      
      try {
        const loggedUser = localStorage.getItem('loggedUser');
        if (!loggedUser) {
          window.location.href = '../index.html';
          return;
        }

        await DataPreloader.loadAll(loggedUser);
        runWorkouts = DataPreloader.getAllRunWorkouts();
        
        // Check if coming from plan-view
        const planWorkout = sessionStorage.getItem('currentWorkout');
        if (planWorkout) {
          try {
            const info = JSON.parse(planWorkout);
            if (info.workoutType === 'run') {
              console.log('ğŸ¯ Loading from plan-view:', info.workoutName);
              v7PlanInfo = info;
              showView('loading-view');
              startWorkout(info.workoutName);
              return;
            }
          } catch (e) {
            console.warn('Failed to parse plan workout:', e);
          }
        }

        // Show selector
        showView('selector-view');
        renderWorkoutList();
        
      } catch (error) {
        console.error('âŒ Init failed:', error);
        showView('selector-view');
        document.getElementById('no-workouts').style.display = 'flex';
      }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // VIEW MANAGEMENT
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function showView(viewId) {
      document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
      document.getElementById(viewId)?.classList.add('active');
    }

    function renderWorkoutList() {
      const list = document.getElementById('workout-list');
      const workoutNames = Object.keys(runWorkouts);
      
      if (workoutNames.length === 0) {
        document.getElementById('no-workouts').style.display = 'flex';
        return;
      }

      list.innerHTML = workoutNames.map(name => {
        const w = runWorkouts[name];
        const est = w.estimatedDistance || w.estimatedTime || `${w.phases?.length || 0} fasi`;
        return `
          <div class="workout-card" onclick="window.startWorkout('${name.replace(/'/g, "\\'")}')">
            <div class="workout-icon">
              <svg viewBox="0 0 24 24"><circle cx="12" cy="5" r="3"/><path d="M12 8v8"/><path d="M8 21l4-5 4 5"/></svg>
            </div>
            <div class="workout-info">
              <h3>${name}</h3>
              <p>${est}</p>
            </div>
            <span class="workout-arrow">â†’</span>
          </div>
        `;
      }).join('');
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // START WORKOUT
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    window.startWorkout = function(name) {
      currentWorkout = runWorkouts[name];
      currentWorkoutName = name;
      
      if (!currentWorkout?.phases?.length) {
        alert('Workout non valido');
        return;
      }

      // Expand phases (handle loops)
      expandedPhases = expandPhases(currentWorkout.phases);
      currentPhaseIndex = 0;
      
      // Reset stats
      totalDistance = 0;
      phaseDistance = 0;
      startTime = Date.now();
      phaseStartTime = Date.now();
      isPaused = false;

      // Update UI
      document.getElementById('workout-name').textContent = name;
      showView('workout-view');
      
      // Start GPS tracking
      startGPS();
      
      // Start global timer
      if (timerInterval) clearInterval(timerInterval);
      timerInterval = setInterval(updateGlobalTimer, 1000);
      
      // Render first phase
      renderCurrentPhase();
    };

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // EXPAND PHASES (Handle Loops)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function expandPhases(phases) {
      const expanded = [];
      let i = 0;
      
      while (i < phases.length) {
        const phase = phases[i];
        
        if (phase.loopGroup) {
          // Collect all phases in this loop group
          const loopPhases = [];
          const loopGroup = phase.loopGroup;
          const loopCount = phase.loopCount || 1;
          
          while (i < phases.length && phases[i].loopGroup === loopGroup) {
            loopPhases.push(phases[i]);
            i++;
          }
          
          // Expand the loop
          for (let rep = 1; rep <= loopCount; rep++) {
            loopPhases.forEach(lp => {
              expanded.push({
                ...lp,
                _loopRep: rep,
                _loopTotal: loopCount,
                _loopSize: loopPhases.length
              });
            });
          }
        } else {
          // Single phase, no loop
          expanded.push({ ...phase, _loopRep: null, _loopTotal: null });
          i++;
        }
      }
      
      return expanded;
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // RENDER CURRENT PHASE
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function renderCurrentPhase() {
      const phase = expandedPhases[currentPhaseIndex];
      if (!phase) return;

      // Update phase counter
      document.getElementById('phase-counter').textContent = `${currentPhaseIndex + 1} / ${expandedPhases.length}`;
      
      // Update total progress bar
      const totalProgress = ((currentPhaseIndex) / expandedPhases.length) * 100;
      document.getElementById('total-progress-fill').style.width = `${totalProgress}%`;

      // Update section label
      const sectionLabels = { warmup: 'ğŸ”¥ WARMUP', main: 'ğŸ’ª MAIN', cooldown: 'â„ï¸ COOLDOWN' };
      document.getElementById('section-label').textContent = sectionLabels[phase.section] || phase.section?.toUpperCase() || 'MAIN';

      // Update zone styling
      const card = document.getElementById('phase-card');
      card.className = `phase-card zone-${phase.zone}`;
      document.getElementById('zone-badge').textContent = `ZONA ${phase.zone}`;

      // Update phase value and unit
      const unitLabels = { km: 'chilometri', m: 'metri', min: 'minuti', sec: 'secondi' };
      document.getElementById('phase-value').textContent = phase.value;
      document.getElementById('phase-unit').textContent = unitLabels[phase.unit] || phase.unit;
      document.getElementById('phase-description').textContent = phase.description || getZoneDescription(phase.zone);

      // Update loop indicator
      const loopIndicator = document.getElementById('loop-indicator');
      if (phase._loopRep) {
        loopIndicator.style.display = 'flex';
        document.getElementById('loop-text').textContent = `Ripetizione ${phase._loopRep}/${phase._loopTotal}`;
        
        // Render loop dots
        const dotsContainer = document.getElementById('loop-dots');
        dotsContainer.innerHTML = '';
        for (let d = 1; d <= phase._loopTotal; d++) {
          const dot = document.createElement('div');
          dot.className = 'loop-dot' + (d < phase._loopRep ? ' completed' : d === phase._loopRep ? ' active' : '');
          dotsContainer.appendChild(dot);
        }
      } else {
        loopIndicator.style.display = 'none';
      }

      // Reset phase progress
      phaseDistance = 0;
      document.getElementById('phase-progress-fill').style.width = '0%';
      document.getElementById('phase-current').textContent = '0';
      
      // Set target display
      const targetText = phase.unit === 'km' ? `${phase.value} km` : 
                         phase.unit === 'm' ? `${phase.value} m` :
                         phase.unit === 'min' ? `${phase.value}:00` :
                         `${phase.value} sec`;
      document.getElementById('phase-target').textContent = targetText;

      // Handle time-based phases (start countdown)
      if (countdownInterval) clearInterval(countdownInterval);
      
      if (phase.unit === 'min' || phase.unit === 'sec') {
        phaseTimeRemaining = phase.unit === 'min' ? phase.value * 60 : phase.value;
        phaseStartTime = Date.now();
        countdownInterval = setInterval(updatePhaseCountdown, 1000);
        updatePhaseCountdown(); // Initial update
      }

      // Update next preview
      updateNextPreview();
      
      // Update button state
      updateNextButton();
    }

    function getZoneDescription(zone) {
      const descriptions = {
        1: 'Recupero / Camminata',
        2: 'Corsa lenta - Aerobico',
        3: 'Ritmo moderato',
        4: 'Ritmo sostenuto - Soglia',
        5: 'Molto forte - VO2max'
      };
      return descriptions[zone] || '';
    }

    function updateNextPreview() {
      const nextIndex = currentPhaseIndex + 1;
      const previewEl = document.getElementById('next-preview-content');
      
      if (nextIndex >= expandedPhases.length) {
        previewEl.textContent = 'ğŸ Fine workout';
        return;
      }

      const next = expandedPhases[nextIndex];
      let preview = `${next.value} ${next.unit} Z${next.zone}`;
      if (next.description) preview += ` - ${next.description}`;
      if (next._loopRep === 1) preview = `ğŸ”„ Loop: ${preview}`;
      
      previewEl.textContent = preview;
    }

    function updateNextButton() {
      const btn = document.getElementById('next-btn');
      if (currentPhaseIndex >= expandedPhases.length - 1) {
        btn.textContent = 'COMPLETA âœ“';
        btn.className = 'ctrl-btn complete';
      } else {
        btn.textContent = 'NEXT â†’';
        btn.className = 'ctrl-btn primary';
      }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // PHASE NAVIGATION
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    window.nextPhase = function() {
      if (currentPhaseIndex >= expandedPhases.length - 1) {
        completeWorkout();
        return;
      }
      
      currentPhaseIndex++;
      phaseStartTime = Date.now();
      renderCurrentPhase();
      vibrate();
    };

    window.prevPhase = function() {
      if (currentPhaseIndex > 0) {
        currentPhaseIndex--;
        phaseStartTime = Date.now();
        renderCurrentPhase();
      }
    };

    window.togglePause = function() {
      isPaused = !isPaused;
      const btn = document.getElementById('pause-btn');
      btn.textContent = isPaused ? 'â–¶ï¸ RIPRENDI' : 'â¸ï¸ PAUSA';
      btn.className = isPaused ? 'ctrl-btn primary' : 'ctrl-btn pause';
    };

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // GPS TRACKING
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function startGPS() {
      if (!navigator.geolocation) {
        console.warn('GPS not available');
        return;
      }

      updateGPSStatus('searching');
      
      gpsWatchId = navigator.geolocation.watchPosition(
        handleGPSPosition,
        handleGPSError,
        { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 }
      );

      // Request wake lock
      requestWakeLock();
    }

    function handleGPSPosition(position) {
      if (isPaused) return;
      
      const { latitude, longitude, accuracy } = position.coords;
      updateGPSStatus('active');

      if (accuracy > 50) return; // Skip inaccurate readings

      if (gpsPositions.length > 0) {
        const last = gpsPositions[gpsPositions.length - 1];
        const dist = calcDistance(last.latitude, last.longitude, latitude, longitude);
        
        if (dist > 1 && dist < 100) { // Reasonable distance change
          totalDistance += dist;
          phaseDistance += dist;
          updateDistanceDisplays();
          checkPhaseCompletion();
        }
      }

      gpsPositions.push({ latitude, longitude, accuracy, timestamp: Date.now() });
      updatePace();
    }

    function handleGPSError(error) {
      console.warn('GPS Error:', error.message);
      updateGPSStatus('error');
    }

    function updateGPSStatus(status) {
      const dot = document.getElementById('gps-dot');
      const text = document.getElementById('gps-status-text');
      
      dot.className = 'gps-dot ' + status;
      text.textContent = status === 'active' ? 'GPS ATTIVO' : 
                         status === 'searching' ? 'RICERCA...' : 
                         status === 'error' ? 'ERRORE GPS' : 'GPS OFF';
    }

    function calcDistance(lat1, lon1, lat2, lon2) {
      const R = 6371000; // Earth radius in meters
      const Ï†1 = lat1 * Math.PI / 180;
      const Ï†2 = lat2 * Math.PI / 180;
      const Î”Ï† = (lat2 - lat1) * Math.PI / 180;
      const Î”Î» = (lon2 - lon1) * Math.PI / 180;
      const a = Math.sin(Î”Ï†/2)**2 + Math.cos(Ï†1) * Math.cos(Ï†2) * Math.sin(Î”Î»/2)**2;
      return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    }

    function updateDistanceDisplays() {
      // Total distance
      document.getElementById('gps-distance').textContent = (totalDistance / 1000).toFixed(2);
      
      // Phase progress for distance-based phases
      const phase = expandedPhases[currentPhaseIndex];
      if (phase && (phase.unit === 'km' || phase.unit === 'm')) {
        const targetMeters = phase.unit === 'km' ? phase.value * 1000 : phase.value;
        const progress = Math.min((phaseDistance / targetMeters) * 100, 100);
        
        document.getElementById('phase-progress-fill').style.width = `${progress}%`;
        document.getElementById('phase-current').textContent = 
          phase.unit === 'km' ? (phaseDistance / 1000).toFixed(2) + ' km' : Math.round(phaseDistance) + ' m';
      }
    }

    function updatePace() {
      if (!startTime || totalDistance < 100) return;
      
      const elapsedMin = (Date.now() - startTime) / 60000;
      const distKm = totalDistance / 1000;
      
      if (distKm > 0) {
        const pace = elapsedMin / distKm;
        const min = Math.floor(pace);
        const sec = Math.floor((pace % 1) * 60);
        if (min < 30) {
          document.getElementById('gps-pace').textContent = `${min}:${sec.toString().padStart(2, '0')}`;
        }
      }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // TIMERS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function updateGlobalTimer() {
      if (isPaused || !startTime) return;
      
      const elapsed = Date.now() - startTime;
      const min = Math.floor(elapsed / 60000);
      const sec = Math.floor((elapsed % 60000) / 1000);
      document.getElementById('gps-time').textContent = 
        `${min.toString().padStart(2, '0')}:${sec.toString().padStart(2, '0')}`;
    }

    function updatePhaseCountdown() {
      if (isPaused) return;
      
      const phase = expandedPhases[currentPhaseIndex];
      if (!phase || (phase.unit !== 'min' && phase.unit !== 'sec')) return;

      const elapsed = Math.floor((Date.now() - phaseStartTime) / 1000);
      const totalSec = phase.unit === 'min' ? phase.value * 60 : phase.value;
      const remaining = Math.max(0, totalSec - elapsed);
      
      // Update display
      const min = Math.floor(remaining / 60);
      const sec = remaining % 60;
      document.getElementById('phase-current').textContent = 
        `${min}:${sec.toString().padStart(2, '0')}`;
      
      // Update progress
      const progress = ((totalSec - remaining) / totalSec) * 100;
      document.getElementById('phase-progress-fill').style.width = `${progress}%`;
      
      // Check completion
      if (remaining <= 0) {
        clearInterval(countdownInterval);
        vibrate();
        
        // Auto-advance after short delay
        setTimeout(() => {
          if (!isPaused && currentPhaseIndex < expandedPhases.length - 1) {
            nextPhase();
          } else if (currentPhaseIndex >= expandedPhases.length - 1) {
            completeWorkout();
          }
        }, 500);
      }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // PHASE COMPLETION CHECK
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function checkPhaseCompletion() {
      const phase = expandedPhases[currentPhaseIndex];
      if (!phase || isPaused) return;

      // Only auto-advance for distance-based phases
      if (phase.unit === 'km' || phase.unit === 'm') {
        const targetMeters = phase.unit === 'km' ? phase.value * 1000 : phase.value;
        
        if (phaseDistance >= targetMeters) {
          vibrate();
          
          // Auto-advance
          setTimeout(() => {
            if (!isPaused && currentPhaseIndex < expandedPhases.length - 1) {
              nextPhase();
            } else if (currentPhaseIndex >= expandedPhases.length - 1) {
              completeWorkout();
            }
          }, 500);
        }
      }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // WORKOUT COMPLETION
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function completeWorkout() {
      // Stop tracking
      if (gpsWatchId) {
        navigator.geolocation.clearWatch(gpsWatchId);
        gpsWatchId = null;
      }
      if (timerInterval) clearInterval(timerInterval);
      if (countdownInterval) clearInterval(countdownInterval);
      if (wakeLock) { wakeLock.release(); wakeLock = null; }

      // Update completion stats
      document.getElementById('final-distance').textContent = (totalDistance / 1000).toFixed(2) + ' km';
      
      if (startTime) {
        const elapsed = Date.now() - startTime;
        const min = Math.floor(elapsed / 60000);
        const sec = Math.floor((elapsed % 60000) / 1000);
        document.getElementById('final-time').textContent = 
          `${min.toString().padStart(2, '0')}:${sec.toString().padStart(2, '0')}`;
      }

      // Save progress if coming from plan
      if (v7PlanInfo) {
        savePlanProgress();
      }

      showView('completion-view');
      vibrate([200, 100, 200]);
    }

    function savePlanProgress() {
      const progressKey = `viltrum_plan_progress_${v7PlanInfo.planName}`;
      const progress = {
        lastWorkoutIndex: v7PlanInfo.workoutIndex,
        totalWorkouts: v7PlanInfo.totalWorkouts,
        lastUpdated: new Date().toISOString()
      };
      localStorage.setItem(progressKey, JSON.stringify(progress));

      // Sync to cloud
      const email = localStorage.getItem('loggedUser');
      if (email) {
        const url = `${GOOGLE_SCRIPT_URL}?action=saveLastWorkout&email=${encodeURIComponent(email)}&planName=${encodeURIComponent(v7PlanInfo.planName)}&lastWorkoutIndex=${v7PlanInfo.workoutIndex}&totalWorkouts=${v7PlanInfo.totalWorkouts}`;
        fetch(url).catch(e => console.warn('Cloud sync failed:', e));
      }

      sessionStorage.removeItem('currentWorkout');
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // NAVIGATION
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    window.goBack = function() {
      const workoutView = document.getElementById('workout-view');
      
      if (workoutView.classList.contains('active')) {
        if (confirm('Vuoi uscire dal workout?')) {
          cleanup();
          if (v7PlanInfo) {
            sessionStorage.removeItem('currentWorkout');
            window.location.href = 'plan-view.html';
          } else {
            showView('selector-view');
          }
        }
      } else {
        window.location.href = 'dashboard-v7.html';
      }
    };

    window.goBackToDashboard = function() {
      cleanup();
      if (v7PlanInfo) {
        window.location.href = 'plan-view.html';
      } else {
        window.location.href = 'dashboard-v7.html';
      }
    };

    function cleanup() {
      if (gpsWatchId) { navigator.geolocation.clearWatch(gpsWatchId); gpsWatchId = null; }
      if (timerInterval) clearInterval(timerInterval);
      if (countdownInterval) clearInterval(countdownInterval);
      if (wakeLock) { wakeLock.release(); wakeLock = null; }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // UTILITIES
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function vibrate(pattern = 200) {
      if (navigator.vibrate) navigator.vibrate(pattern);
    }

    async function requestWakeLock() {
      if ('wakeLock' in navigator) {
        try {
          wakeLock = await navigator.wakeLock.request('screen');
        } catch (e) {
          console.warn('Wake lock failed:', e);
        }
      }
    }

    // Keyboard controls
    document.addEventListener('keydown', (e) => {
      if (!currentWorkout) return;
      if (e.key === 'ArrowRight' || e.key === ' ' || e.key === 'Enter') { e.preventDefault(); nextPhase(); }
      else if (e.key === 'ArrowLeft') { e.preventDefault(); prevPhase(); }
      else if (e.key === 'p') { togglePause(); }
      else if (e.key === 'Escape') { goBack(); }
    });

    // Handle visibility changes (re-request wake lock)
    document.addEventListener('visibilitychange', async () => {
      if (document.visibilityState === 'visible' && currentWorkout && !isPaused) {
        requestWakeLock();
      }
    });

    // Initialize
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>